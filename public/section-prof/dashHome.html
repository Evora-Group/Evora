<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Home</title>
    <link rel="stylesheet" href="../css/dashHome.css">
    <link rel="shortcut icon" href="../assets/imgs/logoEvora.svg" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-solid-rounded/css/uicons-solid-rounded.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
</head>

<body>
    <header>
        <img src="../assets/imgs/logo-nome.svg" alt="" class="img_logo">

         <a href="../index.html" class="botao-sair-mobile">
            <i class="fi fi-sr-exit"></i>
        </a>
    </header>
    <main>
        <aside>
            <section class="section_aside">
                <ul>
                    <li><a href="./dashHome.html"><i class="fi fi-sr-home"></i>Dashboard</a></li>
                    <li><a href="./dashCurso.html" class="active"><i class="fi fi-sr-users-alt"></i>Cursos</a></li>
                    <li><a href="./dashAlunos.html"><i class="fi fi-sr-user"></i>Alunos</a></li>
                    <li><a href="./dashConf.html"><i class="fi fi-sr-settings"></i>Configurações</a></li>
                </ul>

                <a href="../index.html" class="botao-sair">
                    <i class="fi fi-sr-exit"></i> SAIR
                </a>
            </section>
        </aside>


       <section class="section_dash">
            <main class="main_dash">

                <div class="info-entrada">
                    <span id="titulo-entrada">
                        Bem Vindo, <span id="nome-usuario">Rosim</span>!
                    </span>

                    <br>

                    <span id="descricao-entrada">
                        Aqui estão suas principais informações
                    </span>
                </div>

                <section class="header_kpis">

                    <section class="kpi">
                        <div class="kpi_header">
                            <div class="icon_kpi">
                                <i id="icon_indicador" class="fi fi-sr-users"></i>
                            </div>
                            <div class="div_titulo_kpi" id="div_situacao_1">
                                <h1 id="totalMatriculado"></h1>
                                <p class="p_titulo_kpi">Total de Alunos</p>
                                <span class="indicativos-desc">
                                    <i id="seta" class="fi fi-sr-minus"></i>
                                    <p id="matriculadoAtualMes"> <span>Esse mês</span></p>
                                </span>
                            </div>
                        </div>
                    </section>

                    <section class="kpi">
                        <div class="kpi_header">
                            <div class="icon_kpi">
                                <i id="icon_indicador" class="fi fi-sr-users"></i>
                            </div>
                            <div class="div_titulo_kpi" id="div_situacao_2">
                                <h1 id="indicativo-abaixo-media"></h1>
                                <p class="p_titulo_kpi">Alunos Abaixo da Média</p>
                                <span class="indicativos-desc">
                                    <i id="seta-abaixo" class="fi fi-sr-minus"></i>
                                    <p id="indicativo-abaixo-mensal"> <span>Este semestre</span></p>
                                </span>
                            </div>
                        </div>
                    </section>

                    <section class="kpi">
                        <div class="kpi_header">
                            <div class="icon_kpi">
                                <i id="icon_indicador" class="fi fi-sr-arrow-down-left"></i>
                            </div>
                            <div class="div_titulo_kpi" id="div_situacao_3">
                                <h1 id="indicativo-abandono"></h1>
                                <p class="p_titulo_kpi">Abandono de Alunos</p>
                                <span class="indicativos-desc">
                                    <i id="seta-abandono" class="fi fi-sr-minus"></i>
                                    <p id="indicativoAbandonoMensal"><span>Este semestre</span></p>
                                </span>
                            </div>
                        </div>
                    </section>

                    <section class="kpi">
                        <div class="kpi_header">
                            <div class="icon_kpi">
                                <i id="icon_indicador" class="fi fi-sr-plus"></i>
                            </div>
                            <div class="div_titulo_kpi" id="div_situacao_4">
                                <h1 id="indicativo-matricula"></h1>
                                <p class="p_titulo_kpi">Novas Mátriculas no Mês</p>
                                <span class="indicativos-desc">
                                    <i id="seta-matriculas" class="fi fi-sr-minus"></i>
                                    <p id="indicativoAtualMesMatriculas"><span>Este mês</span></p>
                                </span>
                            </div>
                        </div>
                    </section>
                </section>

                <section class="section_main">
                    <div class="chart-container">
                        <h3>Top 3 cursos com maior risco de evasão</h3>

                        <ul class="bar-chart">
                            <li>
                                <span class="label">Pedagogia</span>
                                <div class="bar-wrapper">
                                    <div class="bar" style="width: 90%;"></div>
                                </div>
                            </li>
                        </ul>

                        <div class="chart-axis">
                            <span>0</span>
                            <span>25%</span>
                            <span>50%</span>
                            <span>75%</span>
                            <span>100%</span>
                        </div>
                    </div>

                    <div class="chart-container-mobile">
                        <h3>3 cursos com maior risco de evasão</h3>

                        <ul id="lista_cursos_risco">
                            <li>
                                <p></p>
                                <h1><strong></strong></h1>
                            </li>
                        </ul>

                    </div>


                    <div class="donut-container">
                        <h3>Taxa de Aprovação Média</h3>
                        <div class="donut-chart" style="--value: 72; --color: #2563eb;">
                            <div class="donut-center-text">
                                <span>Aprovação</span>
                                <strong>72%</strong>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </section>
    </main>
</body>

</html>


<script>
    const idInstituicao = sessionStorage.getItem("fkInstituicao");
    const nomeUsuario = sessionStorage.getItem("nomeUsuario");

    if (!idInstituicao) {
        alert("Erro: Instituição não encontrada. Faça login novamente.");
        window.location.href = "../login.html";
    }

    document.getElementById("nome-usuario").innerText = nomeUsuario;

    function totalAlunos() {
        fetch(`/dash/totalAlunos/${idInstituicao}`)
            .then(res => res.json())
            .then(data => {
                console.log("Resposta totalAlunos:", data);
                const total = data?.TotalAlunos ?? (Array.isArray(data) && data[0]?.TotalAlunos) ?? 0;
                document.getElementById("totalMatriculado").innerText = total;
            })
            .catch(err => {
                console.error("Erro total alunos:", err);
                document.getElementById("totalMatriculado").innerText = "Erro";
            });
    }

    function abaixoMedia() {
        fetch(`/dash/alunosAbaixoMedia/${idInstituicao}`)
            .then(res => res.json())
            .then(data => {
                const valor = Number(data.percentual_media_baixa).toFixed(1);
                document.getElementById("indicativo-abaixo-media").innerHTML = valor + "%";
            })
            .catch(err => {
                console.error("Erro abaixo da média:", err);
                document.getElementById("indicativo-abaixo-media").innerHTML = "Erro";
            });
    }

function atualizarTotalAlunosInativos() {
    fetch(`/dash/totalAlunosInativos/${idInstituicao}`) 
        .then(res => res.json())
        .then(data => {
            const valor = parseInt(data.total_alunos_inativos || 0);
            
            document.getElementById("indicativo-abandono").innerHTML = valor;
        })
        .catch(err => {
            console.error("Erro total alunos inativos:", err);
            document.getElementById("indicativo-abandono").innerHTML = "Erro";
        });
}

    function novasMatriculas() {
        fetch(`/dash/novasMatriculas/${idInstituicao}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById("indicativo-matricula").innerHTML = data.novas_matriculas || 0;
            })
            .catch(err => {
                console.error("Erro novas matrículas:", err);
                document.getElementById("indicativo-matricula").innerHTML = "Erro";
            });
    }
    function graficoTop5Evasao() {
        const lista = document.querySelector(".bar-chart");

        fetch(`/dash/top5Evasao/${idInstituicao}`)
            .then(res => {
                if (!res.ok) throw new Error("Erro HTTP " + res.status);
                return res.json();
            })
            .then(data => {
                lista.innerHTML = ""; 

                if (!data || data.length === 0) {
                    lista.innerHTML = '<li><span>Nenhum dado disponível</span></li>';
                    return;
                }

                data.forEach(item => {
                    const percentual = Number(item.percentual).toFixed(1);
                    const nome = item.nomeCurso || "Sem nome";

                    lista.innerHTML += `
                        <li>
                            <span class="label">${nome}</span>
                            <div class="bar-wrapper">
                                <div class="bar" style="width: ${percentual}%;"></div>
                                <span class="bar-value">${percentual}%</span>
                            </div>
                        </li>
                    `;
                });
            })
            .catch(err => {
                console.error("Erro no Top 5 Evasão:", err);
                lista.innerHTML = '<li><span>Erro ao carregar</span></li>';
            });
    }

    function graficoTaxaAprovacao() {
        fetch(`/dash/taxaAprovacao/${idInstituicao}`)
            .then(res => res.json())
            .then(data => {
                const valor = Number(data.percentualAprovacao).toFixed(1);

                const donut = document.querySelector(".donut-chart");
                const texto = donut.querySelector(".donut-center-text strong");

                texto.innerHTML = `${valor}%`;
                donut.style.setProperty("--value", valor);
            })
            .catch(err => {
                console.error("Erro taxa aprovação:", err);
                document.querySelector(".donut-center-text strong").innerHTML = "Erro";
            });
    }


    function atualizarVariacaoTotalAlunos() {
        fetch(`/dash/variacaoMatriculasDoMes/${idInstituicao}`)
            .then(res => res.json())
            .then(data => {
                const texto = document.getElementById("matriculadoAtualMes");
                const seta = document.getElementById("seta");

                if (data.variacao === 0) {
                    seta.className = "fi fi-sr-minus";
                    seta.style.color = "#888";
                    texto.style.color = "#888";
                    texto.innerHTML = `0% <span>Este mês</span>`;
                }
                else if (data.direcao === "up") {
                    seta.className = "fi fi-sr-arrow-up-right";
                    seta.style.color = "#10b981"; 
                    texto.style.color = "#10b981";
                    texto.innerHTML = `+${data.variacao}% <span>Este mês</span>`;
                }
                else if (data.direcao === "down") {
                    seta.className = "fi fi-sr-arrow-down-left";
                    seta.style.color = "#ef4444";
                    texto.style.color = "#ef4444";
                    texto.innerHTML = `-${data.variacao}% <span>Este mês</span>`;
                }
            })
            .catch(err => {
                console.error("Erro comparativo total alunos:", err);
                document.getElementById("matriculadoAtualMes").innerHTML = "Erro";
            });
    }


 function atualizarVariacaoAbaixoMedia() {
    fetch(`/dash/comparativoAbaixoMedia/${idInstituicao}`)
        .then(res => res.json())
        .then(data => {
            const texto = document.getElementById("indicativo-abaixo-mensal");
            const seta = document.getElementById("seta-abaixo");

            const variacaoAbsoluta = Math.abs(data.variacao);
            const textoVariacao = `${variacaoAbsoluta} Aluno${variacaoAbsoluta !== 1 ? 's' : ''}`;

            if (data.direcao === "up") {
                seta.className = "fi fi-sr-arrow-up-right";
                seta.style.color = "#ef4444"; 
                texto.style.color = "#ef4444";
                texto.innerHTML = `+${textoVariacao} <span>em atenção Este mês</span>`;
            }
            else if (data.direcao === "down") {
                seta.className = "fi fi-sr-arrow-down-left";
                seta.style.color = "#10b981"; 
                texto.style.color = "#10b981";
                texto.innerHTML = `-${textoVariacao} <span>em atenção Este mês</span>`;
            }
            else {
                seta.className = "fi fi-sr-minus";
                seta.style.color = "#888";
                texto.style.color = "#888";
                texto.innerHTML = `Nenhuma variação <span>em atenção Este mês</span>`;
            }
        })
        .catch(err => {
            console.error("Erro comparativo abaixo da média:", err);
            document.getElementById("indicativo-abaixo-mensal").innerHTML = "Erro";
        });
}

    function atualizarVariacaoRiscoContagem() { 
    fetch(`/dash/comparativoRiscoContagem/${idInstituicao}`) 
        .then(res => res.json())
        .then(data => {
            const texto = document.getElementById("indicativoAbandonoMensal");
            const seta = document.getElementById("seta-abandono");

            const variacaoAbsoluta = Math.abs(data.variacao);
            const textoVariacao = `${variacaoAbsoluta} Aluno${variacaoAbsoluta !== 1 ? 's' : ''}`;

            if (data.direcao === "up") {
                seta.className = "fi fi-sr-arrow-up-right";
                seta.style.color = "#ef4444"; 
                texto.style.color = "#ef4444";
                texto.innerHTML = `+${textoVariacao} <span>em Risco Este mês</span>`;
            } else if (data.direcao === "down") {
                seta.className = "fi fi-sr-arrow-down-left";
                seta.style.color = "#10b981"; 
                texto.style.color = "#10b981";
                texto.innerHTML = `-${textoVariacao} <span>em Risco Este mês</span>`;
            } else {
                seta.className = "fi fi-sr-minus";
                seta.style.color = "#888";
                texto.style.color = "#888";
                texto.innerHTML = `0 Variação <span>Líquida</span>`;
            }
        })
        .catch(err => {
            console.error("Erro comparativo de risco (contagem):", err);
        });
}

function atualizarVariacaoNovasMatriculas() {
    fetch(`/dash/comparativoNovasMatriculas/${idInstituicao}`)
        .then(res => res.json())
        .then(data => {
            const texto = document.getElementById("indicativoAtualMesMatriculas");
            const seta = document.getElementById("seta-matriculas");

            if (data.direcao === "up") {
                seta.className = "fi fi-sr-arrow-up-right";
                seta.style.color = "#10b981";
                texto.style.color = "#10b981";
                texto.innerHTML = `+${data.variacao}% <span>Este mês</span>`;
            } else { 
                seta.className = "fi fi-sr-minus";
                seta.style.color = "#888";
                texto.style.color = "#888";
                texto.innerHTML = `0% <span>Este mês</span>`;
            }
        })
        .catch(err => {
            console.error("Erro comparativo novas matrículas:", err);
            document.getElementById("indicativoAtualMesMatriculas").innerHTML = "Erro";
        });
}


    window.onload = function () {
        graficoTop5Evasao();
        graficoTaxaAprovacao();
        totalAlunos();
        abaixoMedia();
        atualizarTotalAlunosInativos();
        novasMatriculas();
        atualizarVariacaoTotalAlunos();
        atualizarVariacaoAbaixoMedia();
        atualizarVariacaoRiscoContagem();
        atualizarVariacaoNovasMatriculas();
    };
</script>