<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/sign-page.css">
    <link rel="shortcut icon" href="assets/imgs/logoEvora.svg" type="image/x-icon">
    <script src="./js/login-cadas.js"></script>
    <!-- <script src="js/cadastro_form.js"></script> -->
    <title>Évora</title>
</head>

<body onload="listarInstituicoes()">
    <div id="div_background"></div>
    <main>

        <section class="section-top">


            <button class="back-btn" onclick="home_back()">

                <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"
                    fill="black">
                    <path d="m313-440 224 224-57 56-320-320 320-320 57 56-224 224h487v80H313Z" />
                </svg>

                Voltar ao site

            </button>


        </section>


        <!-- CONTEÚDO DA PÁGINA DE CADASTRO -->
        <section id="section_sign">



            <div id="div_sign-info">
                <div class="div_logo">
                    <span class="logo-text"><img src="./assets/imgs/logoEvora.svg" alt=""></span>
                </div>
                <div class="div_title_top">
                    <h1>Junte-se à Évora</h1>
                    <span>Crie sua conta em poucos passos simples</span>
                </div>
            </div>
            <!-- PROGRESSO DO CADASTRO -->
            <div id="div_sign-progress">
                <div id="div_text_progress">
                    <span id="span_text_progress_pass">Passo 1 de 3</span>
                    <span id="span_text_progress_complet"></span>
                </div>
                <div id="div_line_progress">
                    <div id="div_percent"></div>
                    <!-- <div id="div_67percent"></div>
                    <div id="div_100percent"></div> -->
                </div>
            </div>
            <!-- CONTEÚDO DO FORMULÁRIO -->
            <div id="div_sign_form">

                <!-- TÍTULO DO FORMULÁRIO -->
                <div class="div_title_form">
                    <h3 id="h3_title_form">Informações básicas</h3>
                    <span id="span_title_form">Vamos começar com suas informações básicas</span><br>
                </div>
                <div class="div_form" id="div_form_inputs">
                    <!-- CONTEÚDO DA PÁGINA DE CADASTRO -->

                    <!-- PARTE 1 -->


                    <form action="">
                        <div class="div_label_input" id="div_funcao_input">
                            <label for="fullName" id="label_form">Nome completo</label>
                            <input id="fullName" value="" type="text" id="input_form" name="fullName"
                                placeholder="Seu nome completo"><br>
                        </div>
                        <div class="div_label_input">
                            <label for="email">Email profissional</label>
                            <input value="" type="email" id="email_id" name="email"
                                placeholder="Seu@instituição.edu.br"><br>
                        </div>
                        <div class="div_label_input">
                            <label for="nome_instituicao">Instituição de ensino</label>
                            <input list="instituicoes" type="nome_instituicao" id="instituicao" name="nome_instituicao"
                                placeholder="Nome da sua instituição"><br>
                            <datalist id="instituicoes">
                                <option value=""></option>
                            </datalist>
                        </div>
                    </form>


                    <!-- PARTE 2 -->
                    <!--                     
                    <form action="">
                        <div class="div_label_input" id="div_funcao_input">
                            <label for="function" id="label_form">Qual é sua função?</label><br>
                            <select name="" id="input_function" name="function">
                                <option value="none">Selecione sua função na Instituição</option>
                                <option value="professor">Professor</option>
                                <option value="Admin">Administrador</option>
                            </select>
                        </div>
                        <div class="div_label_desc" id="div_desc">
               
                            <p id="titulo-desc" class="titulo_desc">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentcolor" id="check_icon"><path d="m424-296 282-282-56-56-226 226-114-114-56 56 170 170Zm56 216q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg>
                                Benefícios da sua conta na Évora
                            </p>

                            <ul id="lista_desc" class="lista_desc">

                                <li>Dashboard personalizado com métricas relevantes para sua função</li>
                                <li>Relatórios automáticos de permanência estudantil</li>
                                <li>Alertas inteligentes sobre riscos de evasão</li>
                            
                            </ul>

                        </div>
                    </form>  -->


                    <!-- Parte 3-->

                    <!-- <form action="">
                        
                        <div class="div_label_input" id="div_senha_input">
                            <label for="function" id="label_form">Crie uma senha</label>
                            <input type="password" id="password_usuario" placeholder="Mínimo 8 caracteres">
                        </div>
                        
                        <div class="div_label_input" id="div_confirma_input">
                            <label for="function" id="label_form">Confirme a senha</label>
                            <input type="password" placeholder="Confirme sua senha" id="passwor_conf_usuario">
                        </div>
                        
                        <div class="div_label_desc" id="div_desc_2">

                            <p id="p_desc">
                                <b>Importante:</b> A Évora é projetada para dados educacionais agregados. Não colete informações pessoais sensíveis de estudantes sem as devidas autorizações.
                            </p>

                        </div>
                    </form> -->

                </div>
                <!-- BOTÕES DE FORMULÁRIO -->
                <div class="div_form_bottom">
                    <button type="reset" id="btn_left" onclick="back_bar()">Voltar</button>
                    <button type="submit" id="btn_right" onclick="verificarEmail()">Próximo</button>
                </div>
                <div class="div_title_bottom">
                    <span>Já tem uma conta? <strong><a href="./login.html">Faça login</a></strong></span>
                </div>
            </div>

        </section>

    </main>
</body>

</html>

<script>

    let progress = 0;

    var emailVar = "";
    var nomeVar = "";
    var instituicaoVar = "";
    var cargoVar = "";
    var senhaVar = "";

    function verificarEmail() {
        var email = email_id.value
        var nome_usuario = fullName.value
        
        // Pega o elemento input e o valor digitado
        var input_instituicao = document.getElementById("instituicao");
        var nome_instituicao_digitado = input_instituicao.value;

        // Lógica para pegar o ID baseado no nome selecionado no Datalist
        var lista_opcoes = document.getElementById("instituicoes").options;
        var id_encontrado = null;

        // Varre as opções para ver qual tem o mesmo nome que foi digitado
        for (var i = 0; i < lista_opcoes.length; i++) {
            if (lista_opcoes[i].value === nome_instituicao_digitado) {
                // Pega o ID que escondemos no atributo data-id
                id_encontrado = lista_opcoes[i].getAttribute("data-id");
                break;
            }
        }

        // Validações
        if (email == "" || nome_usuario == "" || nome_instituicao_digitado == "") {
            alert("Preencha todos os campos");
            return;
        } 
        
        if (id_encontrado == null) {
            alert("Selecione uma instituição válida da lista!");
            return; // Impede de continuar se o ID não for achado
        }

        if (!email.includes("@") || !email.includes(".")) {
            alert("Insira um email válido");
            return;
        }

        // Se chegou aqui, validamos o email na API (opcional, mantendo sua lógica)
        validarEmail(email).then((existe) => {
            if (existe === true) {
                alert("Esse email já está em uso!");
            } else {
                // SUCESSO!
                // Removemos o 'buscarInstituicao' antigo e salvamos o ID direto
                instituicaoVar = id_encontrado; // <--- O ID VAI AQUI (ex: 589)
                emailVar = email;
                nomeVar = nome_usuario;

                pass_bar();
            }
        });
    }

    function verificarCargo() {

        var cargo = input_function.value

        if (cargo == "none") {

            alert("Insira um cargo")

        } else {

            cargoVar = cargo

            pass_bar()

        }

    }

    function verificarSenha() {

        var senha = password_usuario.value
        var confirmacao_senha = passwor_conf_usuario.value

        const temMaiuscula = /[A-Z]/.test(senha);
        const temMinuscula = /[a-z]/.test(senha);
        const temNumero = /[0-9]/.test(senha);
        const temTamanhoMinimo = senha.length >= 8;

        if (!temTamanhoMinimo) {
            alert("A senha deve ao menos 8 caracteres")
        } else if (!temNumero) {
            alert("A senha deve conter ao menos 1 número")
        } else if (!temMaiuscula || !temMinuscula) {
            alert("A senha deve conter ao menos 1 caractere maiúsculo e minúsculo")
        } else if (confirmacao_senha != senha) {
            alert("As senhas não coincidem")
        } else {

            senhaVar = senha;
            cadastrar()

        }

        senhaVar = senha;

    }

    function pass_bar() {


        div_percent = document.getElementById("div_percent")
        div_sign_form = document.getElementById("div_sign_form")
        span_step_progress = document.getElementById("span_text_progress_pass")

        if (progress == 0) {

            progress++;
            div_percent.style.width = "33%";
            console.log("progress-bar -> 33%")
            span_step_progress.innerHTML = "Passo 2 de 3"
            div_sign_form.innerHTML = ` 

                <!-- TÍTULO DO FORMULÁRIO -->
                <div class="div_title_form">
                    <h3 id="h3_title_form">Informações básicas</h3>
                    <span id="span_title_form">Valos começar com suas informações básicas</span><br>
                </div>
                <div class="div_form" id="div_form_inputs">
                    <!-- CONTEÚDO DA PÁGINA DE CADASTRO -->

                    <!-- PARTE 2 -->

                    <form action="">
                        <div class="div_label_input" id="div_funcao_input">
                            <label for="function" id="label_form">Qual é sua função?</label><br>
                            <select name="" id="input_function" name="function">
                                <option value="none">Selecione sua função na Instituição</option>
                                <option value="professor">Professor</option>
                                <option value="Admin">Administrador</option>
                            </select>
                        </div>
                        <div class="div_label_desc" id="div_desc">
               
                            <p id="titulo-desc" class="titulo_desc">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentcolor" id="check_icon"><path d="m424-296 282-282-56-56-226 226-114-114-56 56 170 170Zm56 216q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg>
                                Benefícios da sua conta na Évora
                            </p>

                            <ul id="lista_desc" class="lista_desc">

                                <li>Dashboard personalizado com métricas relevantes para sua função</li>
                                <li>Relatórios automáticos de permanência estudantil</li>
                                <li>Alertas inteligentes sobre riscos de evasão</li>
                            
                            </ul>

                        </div>
                    </form> 

                </div>
                <!-- BOTÕES DE FORMULÁRIO -->
                <div class="div_form_bottom">
                    <button type="reset" id="btn_left" onclick="back_bar()">Voltar</button>
                    <button type="submit" id="btn_right" onclick="verificarCargo()">Próximo</button>
                </div>
                <div class="div_title_bottom">
                     <span>Já tem uma conta? <strong><a href="./login.html">Faça login</a></strong></span>
                </div>
            `;

            span_text_progress_complet.innerHTML = "33.3% completo"

        } else if (progress == 1) {

            progress++;
            div_percent.style.width = "66%";
            console.log("progress-bar -> 66%")
            span_step_progress.innerHTML = "Passo 3 de 3"
            div_sign_form.innerHTML = `
            

                <!-- TÍTULO DO FORMULÁRIO -->
                <div class="div_title_form">
                    <h3 id="h3_title_form">Segurança da conta</h3>
                    <span id="span_title_form">Crie uma senha segura para proteger sua conta</span><br>
                </div>
                <div class="div_form" id="div_form_inputs">
                    <!-- CONTEÚDO DA PÁGINA DE CADASTRO -->

                    <!-- Parte 3-->

                    <form action="">
                        
                        <div class="div_label_input" id="div_senha_input">
                            <label for="function" id="label_form">Crie uma senha</label>
                            <input type="password" id="password_usuario" placeholder="Mínimo 8 caracteres">
                        </div>
                        
                        <div class="div_label_input" id="div_confirma_input">
                            <label for="function" id="label_form">Confirme a senha</label>
                            <input type="password" placeholder="Confirme sua senha" id="passwor_conf_usuario">
                        </div>
                        
                        <div class="div_label_desc" id="div_desc_2">

                            <p id="p_desc">
                                <b>Importante:</b> A Évora é projetada para dados educacionais agregados. Não colete informações pessoais sensíveis de estudantes sem as devidas autorizações.
                            </p>

                        </div>
                    </form>

                </div>
                <!-- BOTÕES DE FORMULÁRIO -->
                <div class="div_form_bottom">
                    <button type="reset" id="btn_left" onclick="back_bar()">Voltar</button>
                    <button type="submit" id="btn_right" onclick="verificarSenha()">Logar</button>
                </div>
                <div class="div_title_bottom">
                    <span>Já tem uma conta? <strong><a href="./login.html">Faça login</a></strong></span>
                </div>

            `;

            span_text_progress_complet.innerHTML = "66.6% completo"

        } else if (progress == 2) {

            progress = 3;
            div_percent.style.width = "100%";
            console.log("progress-bar -> 100%")
            span_text_progress_complet.innerHTML = "100% completo"

        }


    }

    function back_bar() {


        div_percent = document.getElementById("div_percent")
        div_sign_form = document.getElementById("div_sign_form")
        span_step_progress = document.getElementById("span_text_progress_pass")


        console.log("back_bar")

        if (progress == 1) {

            progress--;
            div_percent.style.width = "0%";
            console.log("progress-bar -> 0%")
            span_step_progress.innerHTML = "Passo 1 de 3"
            div_sign_form.innerHTML = `

               
                <!-- TÍTULO DO FORMULÁRIO -->
                <div class="div_title_form">
                    <h3 id="h3_title_form">Informações básicas</h3>
                    <span id="span_title_form">Vamos começar com suas informações básicas</span><br>
                </div>
                <div class="div_form" id="div_form_inputs">
                    <!-- CONTEÚDO DA PÁGINA DE CADASTRO -->

                    <!-- PARTE 1 -->


                    <form action="">
                        <div class="div_label_input" id="div_funcao_input">
                            <label for="fullName" id="label_form">Nome completo</label>
                            <input id="fullName" value="" type="text" id="input_form" name="fullName" placeholder="Seu nome completo"><br>
                        </div>
                        <div class="div_label_input">
                            <label for="email">Email profissional</label>
                            <input value="" type="email" id="email_id" name="email" placeholder="Seu@instituição.edu.br"><br>
                        </div>
                        <div class="div_label_input">
                            <label for="nome_instituicao">Instituição de ensino</label>
                            <input list="instituicoes" type="nome_instituicao" id="instituicao" name="nome_instituicao" placeholder="Nome da sua instituição"><br>
                            <datalist id="instituicoes"></datalist>
                        </div>
                    </form>


                    <!-- PARTE 2 -->
                    <!--                     
                    <form action="">
                        <div class="div_label_input" id="div_funcao_input">
                            <label for="function" id="label_form">Qual é sua função?</label><br>
                            <select name="" id="input_function" name="function">
                                <option value="none">Selecione sua função na Instituição</option>
                                <option value="professor">Professor</option>
                                <option value="Admin">Administrador</option>
                            </select>
                        </div>
                        <div class="div_label_desc" id="div_desc">
               
                            <p id="titulo-desc" class="titulo_desc">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentcolor" id="check_icon"><path d="m424-296 282-282-56-56-226 226-114-114-56 56 170 170Zm56 216q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg>
                                Benefícios da sua conta na Évora
                            </p>

                            <ul id="lista_desc" class="lista_desc">

                                <li>Dashboard personalizado com métricas relevantes para sua função</li>
                                <li>Relatórios automáticos de permanência estudantil</li>
                                <li>Alertas inteligentes sobre riscos de evasão</li>
                            
                            </ul>

                        </div>
                    </form>  -->


                    <!-- Parte 3-->

                    <!-- <form action="">
                        
                        <div class="div_label_input" id="div_senha_input">
                            <label for="function" id="label_form">Crie uma senha</label>
                            <input type="password" id="password_usuario" placeholder="Mínimo 8 caracteres">
                        </div>
                        
                        <div class="div_label_input" id="div_confirma_input">
                            <label for="function" id="label_form">Confirme a senha</label>
                            <input type="password" placeholder="Confirme sua senha" id="passwor_conf_usuario">
                        </div>
                        
                        <div class="div_label_desc" id="div_desc_2">

                            <p id="p_desc">
                                <b>Importante:</b> A Évora é projetada para dados educacionais agregados. Não colete informações pessoais sensíveis de estudantes sem as devidas autorizações.
                            </p>

                        </div>
                    </form> -->

                </div>
                <!-- BOTÕES DE FORMULÁRIO -->
                <div class="div_form_bottom">
                    <button type="reset" id="btn_left" onclick="back_bar()">Voltar</button>
                    <button type="submit" id="btn_right" onclick="verificarEmail()">Próximo</button>
                </div>
                <div class="div_title_bottom">
                    <span>Já tem uma conta? <strong><a href="./login.html">Faça login</a></strong></span>
                </div>

            

            `;

            listarInstituicoes();

            span_text_progress_complet.innerHTML = ""


        } else if (progress == 2) {

            progress--;
            div_percent.style.width = "33%";
            console.log("progress-bar -> 33%")
            span_step_progress.innerHTML = "Passo 2 de 3"

            div_sign_form.innerHTML = `
            

                <!-- TÍTULO DO FORMULÁRIO -->
                <div class="div_title_form">
                    <h3 id="h3_title_form">Informações básicas</h3>
                    <span id="span_title_form">Valos começar com suas informações básicas</span><br>
                </div>
                <div class="div_form" id="div_form_inputs">
                    <!-- CONTEÚDO DA PÁGINA DE CADASTRO -->

                    <!-- PARTE 2 -->

                    <form action="">
                        <div class="div_label_input" id="div_funcao_input">
                            <label for="function" id="label_form">Qual é sua função?</label><br>
                            <select name="" id="input_function" name="function">
                                <option value="none">Selecione sua função na Instituição</option>
                                <option value="professor">Professor</option>
                                <option value="Admin">Administrador</option>
                            </select>
                        </div>
                        <div class="div_label_desc" id="div_desc">
               
                            <p id="titulo-desc" class="titulo_desc">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentcolor" id="check_icon"><path d="m424-296 282-282-56-56-226 226-114-114-56 56 170 170Zm56 216q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg>
                                Benefícios da sua conta na Évora
                            </p>

                            <ul id="lista_desc" class="lista_desc">

                                <li>Dashboard personalizado com métricas relevantes para sua função</li>
                                <li>Relatórios automáticos de permanência estudantil</li>
                                <li>Alertas inteligentes sobre riscos de evasão</li>
                            
                            </ul>

                        </div>
                    </form> 

                </div>
                <!-- BOTÕES DE FORMULÁRIO -->
                <div class="div_form_bottom">
                    <button type="reset" id="btn_left" onclick="back_bar()">Voltar</button>
                    <button type="submit" id="btn_right" onclick="verificarCargo()">Próximo</button>
                </div>
                <div class="div_title_bottom">
                    <span>Já tem uma conta? <strong><a href="./login.html">Faça login</a></strong></span>
                </div>

            `;

            span_text_progress_complet.innerHTML = "33.3% completo"

        } else if (progress == 3) {

            progress--;
            div_percent.style.width = "66%";
            console.log("progress-bar -> 66%")

            span_text_progress_complet.innerHTML = "66.6% completo"

        }

    }

    function home_back() {
        window.location.href = "index.html"
    }

    function cadastrar() {
        // Rota ajustada para /user/cadastrar (baseado no seu controller user)
        fetch("/user/cadastrar", { 
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                // LADO ESQUERDO: O que seu Controller espera (req.body.nomeServer)
                // LADO DIREITO: A variável do Javascript com o valor correto
                cargoServer: cargoVar,
                nomeServer: nomeVar,
                emailServer: emailVar,
                senhaServer: senhaVar,
                
                // O PULO DO GATO:
                // Mandamos na variável 'instituicaoServer' o VALOR DO ID (ex: 589)
                // que capturamos na função verificarEmail
                instituicaoServer: instituicaoVar 
            }),
        })
        .then(function (resposta) {
            console.log("resposta: ", resposta);

            if (resposta.ok) {
                console.log("Cadastro com sucesso")
                pass_bar()
                setTimeout(() => {
                    window.location = "./login.html";
                }, 1000);
            } else {
                resposta.text().then(texto => {
                    console.log("Erro: " + texto);
                    // Mostra o erro sqlMessage que o controller devolve
                    alert("Erro ao realizar cadastro: " + texto);
                });
                throw "Houve um erro ao tentar realizar o cadastro!";
            }
        })
        .catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });

        return false;
    }



</script>